<!DOCTYPE html>
<html lang="cn-ZH" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>FPGA Embedded | Blog time !</title>
    <meta name="description" content="more infomation">
    <link rel="preload stylesheet" href="/MyWeb/assets/style.7ef417c2.css" as="style">
    <script type="module" src="/MyWeb/assets/app.dc712d3b.js"></script>
    <link rel="preload" href="/MyWeb/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/MyWeb/assets/chunks/framework.46f3d25f.js">
  <link rel="modulepreload" href="/MyWeb/assets/chunks/theme.1c26a031.js">
  <link rel="modulepreload" href="/MyWeb/assets/course_FPGAEmbedded.md.11f87350.lean.js">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-b2cf3e0b><!--[--><!--]--><!--[--><span tabindex="-1" data-v-b8b11faa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-b8b11faa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-b2cf3e0b data-v-7e5bc4a5><div class="VPNavBar has-sidebar" data-v-7e5bc4a5 data-v-7683ced7><div class="container" data-v-7683ced7><div class="title" data-v-7683ced7><div class="VPNavBarTitle has-sidebar" data-v-7683ced7 data-v-4d981103><a class="title" href="/MyWeb/" data-v-4d981103><!--[--><!--]--><!--[--><img class="VPImage logo" src="/MyWeb/logo.png" alt data-v-6db2186b><!--]--><!--[-->Blog time !<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-7683ced7><div class="curtain" data-v-7683ced7></div><div class="content-body" data-v-7683ced7><!--[--><!--]--><div class="VPNavBarSearch search" style="--vp-meta-key:&#39;Meta&#39;;" data-v-7683ced7><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-7683ced7 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/MyWeb/course/index.html" tabindex="0" data-v-7f418b0f data-v-5e623618 data-v-8f4dc553><!--[-->course<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/MyWeb/note/index.html" tabindex="0" data-v-7f418b0f data-v-5e623618 data-v-8f4dc553><!--[-->note<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/MyWeb/we/WeNote.html" tabindex="0" data-v-7f418b0f data-v-5e623618 data-v-8f4dc553><!--[-->world edit<!--]--><!----></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-764effdf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-764effdf><span class="text" data-v-764effdf><!----> more <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-764effdf><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-764effdf><div class="VPMenu" data-v-764effdf data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-2f2cfafc><a class="VPLink link" href="/MyWeb/changelog/index.html" data-v-2f2cfafc data-v-8f4dc553><!--[-->更新日志<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-2f2cfafc><a class="VPLink link" href="/MyWeb/links/index.html" data-v-2f2cfafc data-v-8f4dc553><!--[-->友情链接<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-2f2cfafc><a class="VPLink link" href="https://space.bilibili.com/19471313?spm_id_from=333.1007.0.0" target="_blank" rel="noreferrer" data-v-2f2cfafc data-v-8f4dc553><!--[-->BiliBili page<!--]--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" height="24px" viewbox="0 0 24 24" width="24px" class="icon" data-v-8f4dc553><path d="M0 0h24v24H0V0z" fill="none"></path><path d="M9 5v2h6.59L4 18.59 5.41 20 17 8.41V15h2V5H9z"></path></svg></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-7683ced7 data-v-f6a63727><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-f6a63727 data-v-82b282f1 data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-82b282f1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-82b282f1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-7683ced7 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink" href="https://github.com/Fox-Block?tab=overview&amp;from=2023-03-01&amp;to=2023-03-12" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-36371990><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-7683ced7 data-v-40855f84 data-v-764effdf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-764effdf><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-764effdf><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-764effdf><div class="VPMenu" data-v-764effdf data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-40855f84 data-v-82b282f1 data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-82b282f1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-82b282f1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-40855f84><div class="item social-links" data-v-40855f84><div class="VPSocialLinks social-links-list" data-v-40855f84 data-v-7bc22406><!--[--><a class="VPSocialLink" href="https://github.com/Fox-Block?tab=overview&amp;from=2023-03-01&amp;to=2023-03-12" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-36371990><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-7683ced7 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-b2cf3e0b data-v-9074c407><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-9074c407><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-9074c407><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-9074c407>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-9074c407 data-v-687955bc><button data-v-687955bc>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-b2cf3e0b data-v-af16598e><div class="curtain" data-v-af16598e></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-af16598e><span class="visually-hidden" id="sidebar-aria-label" data-v-af16598e> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 has-active" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>课程资料</h2><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link is-active has-active" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/MyWeb/course/FPGAEmbedded.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>ZYNQ embedded</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/MyWeb/course/common-component2.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>part B</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-b2cf3e0b data-v-a494bd1d><div class="VPDoc has-sidebar has-aside" data-v-a494bd1d data-v-c4b0d3cf><!--[--><!--]--><div class="container" data-v-c4b0d3cf><div class="aside" data-v-c4b0d3cf><div class="aside-curtain" data-v-c4b0d3cf></div><div class="aside-container" data-v-c4b0d3cf><div class="aside-content" data-v-c4b0d3cf><div class="VPDocAside" data-v-c4b0d3cf data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-3f215769 data-v-ff0f39c8><div class="content" data-v-ff0f39c8><div class="outline-marker" data-v-ff0f39c8></div><div class="outline-title" data-v-ff0f39c8>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-ff0f39c8><span class="visually-hidden" id="doc-outline-aria-label" data-v-ff0f39c8> Table of Contents for current page </span><ul class="root" data-v-ff0f39c8 data-v-9a431c33><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-c4b0d3cf><div class="content-container" data-v-c4b0d3cf><!--[--><!--]--><!----><main class="main" data-v-c4b0d3cf><div style="position:relative;" class="vp-doc _MyWeb_course_FPGAEmbedded" data-v-c4b0d3cf><div><h1 id="fpga-embedded" tabindex="-1">FPGA Embedded <a class="header-anchor" href="#fpga-embedded" aria-label="Permalink to &quot;FPGA Embedded&quot;">​</a></h1><h2 id="ip-core" tabindex="-1">IP core <a class="header-anchor" href="#ip-core" aria-label="Permalink to &quot;IP core&quot;">​</a></h2><p>The Create and Package New IP wizard can generate Xilinx-supported AXI interfaces. These are: • <strong>AXI4</strong>: For memory-mapped interfaces, which allows burst of up to 256 data transfer cycles with a single address phase. • <strong>AXI4-Lite</strong>: A light-weight, single transaction memory-mapped interface. • <strong>AXI4-Stream</strong>: For high-speed streaming data.</p><h3 id="create-a-custom-ip-using-the-create-and-package-ip-wizard" tabindex="-1">Create a Custom IP using the Create and Package IP Wizard <a class="header-anchor" href="#create-a-custom-ip-using-the-create-and-package-ip-wizard" aria-label="Permalink to &quot;Create a Custom IP using the Create and Package IP Wizard&quot;">​</a></h3><ol><li><p>Open Vivado by selecting <strong>Start &gt; All Programs &gt; Xilinx Design Tools &gt; Vivado 2021.2 &gt; Vivado 2021.2</strong>.</p></li><li><p>Click <strong>Manage IP</strong> and select <strong>New IP Location</strong> and click Next in the New IP Location window.</p></li><li><p>Click on the browse button for the Part section. Click on boards and select the PYNQ-Z2 as your part. Click OK.</p></li><li><p>Select Verilog as the Target Language, Mixed as the Simulator language, and for IP location, type <strong>{labs}\led_ip</strong> and click Finish (leave other settings as defaults and click OK if prompted to create the directory)</p><p><img src="/MyWeb/assets/1_ipst.7e190cc4.jpg" alt="1_ipst"></p></li></ol><h3 id="run-the-create-and-package-ip-wizard" tabindex="-1">Run the Create and Package IP Wizard <a class="header-anchor" href="#run-the-create-and-package-ip-wizard" aria-label="Permalink to &quot;Run the Create and Package IP Wizard&quot;">​</a></h3><ol><li><p>Select <strong>Tools &gt; Create and Package New IP</strong>.</p></li><li><p>In the window, click Next.</p></li><li><p>Select <strong>Create a new AXI4 peripheral</strong>, and click Next.</p></li><li><p>Fill in the details for the IP.</p><p>Name: <em>led_ip</em></p><p>Display Name: <em>led_ip_v1_0</em></p><p>(Fill in a description, Vendor Name, and URL)</p></li><li><p>Click Next.</p></li><li><p>Change the Name of the interface to <strong>S_AXI</strong>.</p></li><li><p>Leave the other settings as default and click <strong>Next</strong> (<em>Lite interface, Slave mode, Data Width: 32, Number of Registers: 4</em>).</p></li><li><p>Select <strong>Edit IP</strong> and click <strong>Finish</strong> (a new Vivado Project will open).</p></li></ol><h3 id="create-an-interface-to-the-leds" tabindex="-1">Create an interface to the LEDs <a class="header-anchor" href="#create-an-interface-to-the-leds" aria-label="Permalink to &quot;Create an interface to the LEDs&quot;">​</a></h3><ol><li><p>In the sources panel, double-click the led_ip_v1_0.v file.</p><p>This file contains the HDL code for the interface(s) selected above. The top level file contains a module which implements the AXI interfacing logic, and an example design to write to and read from the number of registers specified above. This template can be used as a basis for creating custom IP. A new parameterized output port to the LEDs will be created at the top level of the design, and the AXI write data in the sub-module will be connected back up to the external LED port.</p><p>Scroll down to line 7 where a user parameters space is provided.</p></li><li><p>Add the line:</p><div class="language-verilog"><button title="Copy Code" class="copy"></button><span class="lang">verilog</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">parameter</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">integer</span><span style="color:#A6ACCD;"> LED_WIDTH </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;">,</span></span></code></pre></div></li><li><p>Go to line 18 and add the line:</p><div class="language-verilog"><button title="Copy Code" class="copy"></button><span class="lang">verilog</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">output</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">wire</span><span style="color:#A6ACCD;"> [LED_WIDTH</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">] LED,</span></span></code></pre></div><blockquote><p>don&#39;t forget to add commas when adding a port.</p></blockquote></li><li><p>Insert the following at line ~48:</p><div class="language-verilog"><button title="Copy Code" class="copy"></button><span class="lang">verilog</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">.LED_WIDTH(LED_WIDTH),</span></span></code></pre></div></li><li><p>Insert the following at line ~52:</p><div class="language-verilog"><button title="Copy Code" class="copy"></button><span class="lang">verilog</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">.LED(LED),</span></span></code></pre></div></li><li><p>Save the file by selecting <strong>File &gt; Save File</strong>.</p></li><li><p>Expand led_ip_v1_0 in the sources view if necessary, and open led_ip_v1_0_S_AXI.v.</p></li><li><p>Add the LED parameter and port to this file too, at lines 7 and 18 (done in steps 2 ands 3).</p></li><li><p>Scroll down to ~line 400 and insert the following code to instantiate the user logic for the LED IP. (This code can be typed directly, or copied from the user_logic_instantiation.txt file in the lab3 source folder.)</p><div class="language-verilog"><button title="Copy Code" class="copy"></button><span class="lang">verilog</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">lab3_user_logic  # (</span></span>
<span class="line"><span style="color:#A6ACCD;">    .LED_WIDTH(LED_WIDTH)</span></span>
<span class="line"><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">U1(</span></span>
<span class="line"><span style="color:#A6ACCD;">    .S_AXI_ACLK(S_AXI_ACLK),</span></span>
<span class="line"><span style="color:#A6ACCD;">    .slv_reg_wren(slv_reg_wren),</span></span>
<span class="line"><span style="color:#A6ACCD;">    .axi_awaddr(axi_awaddr[C_S_AXI_ADDR_WIDTH</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">:ADDR_LSB]),</span></span>
<span class="line"><span style="color:#A6ACCD;">    .S_AXI_WDATA(S_AXI_WDATA),</span></span>
<span class="line"><span style="color:#A6ACCD;">    .S_AXI_ARESETN(S_AXI_ARESETN),</span></span>
<span class="line"><span style="color:#A6ACCD;">    .LED(LED)</span></span>
<span class="line"><span style="color:#A6ACCD;">);</span></span></code></pre></div><p>Check all the signals that are being connected and where they originate.</p></li><li><p>User logic</p></li></ol><div class="language-verilog"><button title="Copy Code" class="copy"></button><span class="lang">verilog</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">`timescale</span><span style="color:#A6ACCD;"> 1ns </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> 1ps</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/////////////////////////////////////////////////////////////////</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// Module Name: lab3_user_logic</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/////////////////////////////////////////////////////////////////</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">module</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">lab3_user_logic</span><span style="color:#F07178;"> # (</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#F78C6C;">parameter</span><span style="color:#F07178;"> LED_WIDTH </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">8</span></span>
<span class="line"><span style="color:#F07178;">	)</span></span>
<span class="line"><span style="color:#F07178;">	(</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#F78C6C;">input</span><span style="color:#F07178;"> S_AXI_ACLK,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#F78C6C;">input</span><span style="color:#F07178;"> slv_reg_wren,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#F78C6C;">input</span><span style="color:#F07178;"> [</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">] axi_awaddr,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#F78C6C;">input</span><span style="color:#F07178;"> [</span><span style="color:#F78C6C;">31</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">] S_AXI_WDATA,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#F78C6C;">input</span><span style="color:#F07178;"> S_AXI_ARESETN,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#F78C6C;">output</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">reg</span><span style="color:#F07178;"> [LED_WIDTH</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">] LED</span></span>
<span class="line"><span style="color:#F07178;">    );</span></span>
<span class="line"><span style="color:#F07178;">      </span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#F78C6C;">always</span><span style="color:#F07178;"> @( </span><span style="color:#F78C6C;">posedge</span><span style="color:#F07178;"> S_AXI_ACLK )</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#F78C6C;">begin</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#F78C6C;">if</span><span style="color:#F07178;"> ( S_AXI_ARESETN </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1&#39;b0</span><span style="color:#F07178;"> )</span></span>
<span class="line"><span style="color:#F07178;">        LED </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">4&#39;b0</span><span style="color:#F07178;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#F78C6C;">else</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#F78C6C;">if</span><span style="color:#F07178;"> (slv_reg_wren </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> (axi_awaddr </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">3&#39;h0</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">          LED </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> S_AXI_WDATA[LED_WIDTH</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">];	</span><span style="color:#676E95;font-style:italic;">//将AXI总线发送过来的数据转移到LED状态寄存器中</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#F78C6C;">end</span></span>
<span class="line"><span style="color:#C792EA;">endmodule</span></span></code></pre></div><ol start="11"><li><p>Save the file by selecting <strong>File &gt; Save File</strong>.</p></li><li><p>Click on the <strong>Add Sources</strong> in the Flow Navigator pane, select <strong>Add or Create Design Sources</strong>, click <strong>Next</strong>, then click the Plus icon then Add Files…, browse to <strong>{sources}\lab3</strong>, select the lab3_user_logic.v file and click OK, and then click <strong>Finish</strong> to add the file.</p><p>Check the contents of this file to understand the logic that is being implemented. Notice the formed hierarchy.</p><blockquote><p>Make sure that when adding the source lab3_user_logic.v, untick the option: Copy sources into IP directory.</p></blockquote></li><li><p>Click <strong>Run Synthesis</strong> and <strong>Save</strong> if prompted. (This is to check the design synthesizes correctly before packaging the IP. If this was your own design, you would simulate it and verify functionality before proceeding)</p></li><li><p>Check the <em>Messages</em> tab for any errors and correct if necessary before moving to the next step</p><p>When Synthesis completes successfully, click Cancel.</p></li><li><p>Write program to ZYNQ</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xparameters.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xgpio.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">led_ip.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//====================================================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">   XGpio dip</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> push</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> psb_check</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> dip_check</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">xil_printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-- Start of the Program --</span><span style="color:#A6ACCD;">\r\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">XGpio_Initialize</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">dip</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> XPAR_SW_DEVICE_ID</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;"> // Modify this 改为你的拨码开关名称，在xparameters.h中检索</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">XGpio_SetDataDirection</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">dip</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xffffffff</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">XGpio_Initialize</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">push</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> XPAR_BTN_DEVICE_ID</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;"> // Modify this 改为你的按键开关名称，在xparameters.h中检索</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">XGpio_SetDataDirection</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">push</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xffffffff</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	  psb_check </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XGpio_DiscreteRead</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">push</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#82AAFF;">xil_printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Push Buttons Status %x</span><span style="color:#A6ACCD;">\r\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> psb_check</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	  dip_check </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XGpio_DiscreteRead</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">dip</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#82AAFF;">xil_printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">DIP Switch Status %x</span><span style="color:#A6ACCD;">\r\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> dip_check</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">	  </span><span style="color:#676E95;font-style:italic;">// output dip switches value on LED_ip device</span></span>
<span class="line"><span style="color:#89DDFF;">       </span><span style="color:#676E95;font-style:italic;">// 改为你的LED基地址，在xparameters.h中检索</span></span>
<span class="line"><span style="color:#89DDFF;">       </span><span style="color:#676E95;font-style:italic;">// 这个函数通过AXI总线访问LED设备的基地址，由于LED设备只有一个寄存器，因此直接往基地址写入，偏移量为0</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#82AAFF;">LED_IP_mWriteReg</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">XPAR_LED_IP_0_S00_AXI_BASEADDR</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> dip_check</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> i</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F78C6C;">9999999</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> i</span><span style="color:#89DDFF;">++);</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div></li></ol><blockquote><p><strong>WARNING: 如果PL端产生一些错误还是可以生成比特流的，比如说在管脚约束时的错误，此时Vivado 会有critical warning，能生成比特流并且正常下载，但是代码不一定能正常运行。</strong></p></blockquote><h2 id="zynq-启动流程与程序固化" tabindex="-1">ZYNQ 启动流程与程序固化 <a class="header-anchor" href="#zynq-启动流程与程序固化" aria-label="Permalink to &quot;ZYNQ 启动流程与程序固化&quot;">​</a></h2><p>Immediately after the ==PS_POR_B== reset pin deasserts, the hardware samples the ==boot strap pins== and optionally enables the PS clock PLLs. Then, the PS begins executing the ==BootROM==（启动代码存储空间） code in the on-chip ROM to boot the system. The POR resets the entire device with <strong>no previous state saved</strong>. The non-POR type resets also cause the BootROM to execute, but without the hardware sampling the strap pins. After a non-POR reset, some registers values are preserved and the device is aware of its previous security mode. ==Non-POR== resets include the PS_SRST_B pin and several internal reset sources.</p><ul><li>硬复位：PS_POR_B <ul><li>断电重置</li><li>PS_POR_B reset pin</li></ul></li><li>软复位：Non-POR <ul><li>PS_SRST_B pin</li><li>内部重置</li></ul></li></ul><p>The <strong>BootROM is the first software to run in the APU</strong>. The BootROM executes on CPU 0 and CPU 1 executes the wait-for-event (WFE) instruction. <strong>The main tasks of the BootROM are to configure the*<em><strong>system, copy the Boot Image FSBL/User code from the boot device to the OCM, and then branch the</strong></em>code execution to the OCM.</strong> Optionally, the FSBL/User code can be executed directly from a Quad-SPI or NOR device in a non-secure environment.</p><ul><li>FSBL: first stage boot loader</li></ul><p><strong>The PS Master boot device holds one or more boot images</strong>. A boot image is made up of the <strong>BootROM Header</strong> (also referred to as the Boot Image Header) and the first stage boot loader (FSBL). The boot device can also hold a <strong>bitstream</strong> to configure the PL and an <strong>embedded operating system</strong>, but ==these are not accessed by the BootROM code==. The flash memory device for boot can be ==Quad-SPI, NAND, NOR, or SD card==.</p><ul><li>BootROM引导FSBL运行，FSBL载入 bitstream 与嵌入式系统</li></ul><p>The BootROM execution flow is affected by the pin strap settings, the BootROM Header, and what the BootROM code discovers about the system. <em>The BootROM can execute in a secure environment</em> <em>with encrypted FSBL/User code, or a non-secure environment.</em> After the BootROM executes, the FSBL/User code takes responsibility of the system as described in UG821, Zynq-7000 SoC Software Developers Guide.</p><p>For development, the system can be booted in JTAG mode. Or, JTAG can be enabled after a non-secure flash device boot. JTAG always implies a non-secure environment, but it allows for access to the ==Arm debug access port (DAP)== controller in the CPU complex (APU) and th==Xilinx test access port (TAP)== controller in the PL.</p><h3 id="ps-master-boot-mode" tabindex="-1">PS Master Boot Mode <a class="header-anchor" href="#ps-master-boot-mode" aria-label="Permalink to &quot;PS Master Boot Mode&quot;">​</a></h3><p>In master boot mode, the system boots from a flash memory device. Here, the BootROM configures the PS to access the boot device, reads the BootROM header, validates the header, and then usually copies the FSBL/User code to the OCM memory. Master mode can be a secure or non-secure environment.</p><p>In secure mode, the boot image is always written to OCM memory by the CPU. From there, it is sent(using DMA) in and out of the AES/HMAC(高级加密单元/基于hash的消息认证码) units for decryption and authentication. The decrypted boot image is written back to OCM memory and executed after the BootROM is finished. Security hardware is described in this chapter and in Chapter 32, Device Secure Boot.</p><p><img src="/MyWeb/assets/image-20230710110845809.3aa52bc9.png" alt="image-20230710110845809"></p><p>In non-secure mode, the BootROM header can instruct the PS to execute the boot image directly from a Quad-SPI or NOR boot device that supports the ==execute-in-place option==. In other cases, the FSBL/User code is copied to the OCM memory for execution.</p><h3 id="jtag-slave-boot" tabindex="-1">JTAG Slave Boot <a class="header-anchor" href="#jtag-slave-boot" aria-label="Permalink to &quot;JTAG Slave Boot&quot;">​</a></h3><p>In JTAG boot mode, the BootROM code does minimal system configuration and enables a JTAG interface. Then, the system goes into an idle state waiting for the DAP controller to restart CPU 0. The cascade JTAG boot mode loops the DAP and TAP controllers, and is the most common JTAG boot mode. The independent JTAG boot mode connects the TAP controller to the PL JTAG pins and gives time for the user to configure the PL using the TAP controller to connect the DAP controller to the EMIO JTAG interface. The paths are shown in Figure 6-7, page 191.</p><h3 id="device-boot-flowchart" tabindex="-1">Device Boot Flowchart <a class="header-anchor" href="#device-boot-flowchart" aria-label="Permalink to &quot;Device Boot Flowchart&quot;">​</a></h3><p><img src="/MyWeb/assets/image-20230710111524558.7aa6a78e.png" alt="image-20230710111524558"></p><h3 id="bootrom-and-header-parameters" tabindex="-1">BootROM and Header Parameters <a class="header-anchor" href="#bootrom-and-header-parameters" aria-label="Permalink to &quot;BootROM and Header Parameters&quot;">​</a></h3><p>The BootROM header includes a dozen parameters that guide the BootROM execution flow. For example, the header includes a parameter to select the security mode: the Encryption Status parameter. In secure mode, the FSBL/User code, bitstream, and other software are encrypted. The BootROM has the ability to authenticate and decrypt the encrypted FSBL/User code. The header itself is never encrypted. As another example, the header includes the Length of Image parameter that defines the length of the FSBL/User code that the BootROM loads into the OCM for execution. This code is limited to 192 KB in length. This parameter can be set to zero to indicate the desire to execute code directly from the boot device (execute-in-place). All of the header parameters are described in section 6.3.2 BootROM Header. The last two functions of the BootROM are to disable access to its ROM code and transfer CPU codeexecution to the FSBL/User code. The execution of the BootROM is detailed in section 6.3.1 BootROM Flowchart.</p><h3 id="ps-software-boot-stages" tabindex="-1">PS Software Boot Stages <a class="header-anchor" href="#ps-software-boot-stages" aria-label="Permalink to &quot;PS Software Boot Stages&quot;">​</a></h3><ul><li>Stage 0 (BootROM: BootROM Header)</li><li>Stage 1 (FSBL / User code)</li><li>Stage 2 (U-Boot / System / Application)</li></ul><h3 id="boot-mode-pin-settings" tabindex="-1">Boot Mode Pin Settings <a class="header-anchor" href="#boot-mode-pin-settings" aria-label="Permalink to &quot;Boot Mode Pin Settings&quot;">​</a></h3><p><img src="/MyWeb/assets/image-20230710113316104.2b576bb3.png" alt="image-20230710113316104"></p><p><img src="/MyWeb/assets/image-20230710113858444.212c2b72.png" alt="image-20230710113858444"></p><h3 id="程序固化" tabindex="-1">程序固化 <a class="header-anchor" href="#程序固化" aria-label="Permalink to &quot;程序固化&quot;">​</a></h3><h4 id="_1-启用外设" tabindex="-1">1. 启用外设 <a class="header-anchor" href="#_1-启用外设" aria-label="Permalink to &quot;1. 启用外设&quot;">​</a></h4><p>由于ZYNQ架构下固化程序必须借助PS端，通过SD卡读写，因此需要打开SD卡外设（有多个，根据原理图选择），若通过Q-SPI需要打开Q-SPI外设（只有一个）</p><p><img src="/MyWeb/assets/image-20230710114227241.3bb6e8fc.png" alt="image-20230710114227241"></p><blockquote><p>Q-SPI</p></blockquote><p><img src="/MyWeb/assets/image-20230710114448545.163b161f.png" alt="image-20230710114448545"></p><blockquote><p>SD卡设置（适用于EGO1）</p></blockquote><h4 id="_2-加入文件系统" tabindex="-1">2. 加入文件系统 <a class="header-anchor" href="#_2-加入文件系统" aria-label="Permalink to &quot;2. 加入文件系统&quot;">​</a></h4><img src="/MyWeb/assets/image-20230710114832265.26160e92.png" alt="image-20230710114832265" style="zoom:50%;"><img src="/MyWeb/assets/image-20230710114942133.3ce1bca2.png" alt="image-20230710114942133" style="zoom:50%;"><p>选择<code>xiffs</code></p><h4 id="_3-创建fsbl" tabindex="-1">3. 创建FSBL <a class="header-anchor" href="#_3-创建fsbl" aria-label="Permalink to &quot;3. 创建FSBL&quot;">​</a></h4><p>创建新工程，使用FSBL模板即可</p><img src="/MyWeb/assets/image-20230710115050081.d1bddc57.png" alt="image-20230710115050081" style="zoom:50%;"><h4 id="_4-创建启动镜像" tabindex="-1">4. 创建启动镜像 <a class="header-anchor" href="#_4-创建启动镜像" aria-label="Permalink to &quot;4. 创建启动镜像&quot;">​</a></h4><p>选中所需的工程，创建启动镜像</p><img src="/MyWeb/assets/image-20230710115222690.49a557cb.png" alt="image-20230710115222690" style="zoom:50%;"><p>合成文件，注意顺序：</p><img src="/MyWeb/assets/image-20230710115350881.753b7297.png" alt="image-20230710115350881" style="zoom:50%;"><h4 id="_5-将boot-bin拷贝到sd卡-并设置从sd卡启动" tabindex="-1">5. 将<code>Boot.bin</code>拷贝到SD卡，并设置从SD卡启动 <a class="header-anchor" href="#_5-将boot-bin拷贝到sd卡-并设置从sd卡启动" aria-label="Permalink to &quot;5. 将`Boot.bin`拷贝到SD卡，并设置从SD卡启动&quot;">​</a></h4><p>注意需要波动板上的<strong>拨码开关到正确位置</strong>，从而实现从SD卡启动</p><h2 id="ps-gpio-与中断" tabindex="-1">PS GPIO 与中断 <a class="header-anchor" href="#ps-gpio-与中断" aria-label="Permalink to &quot;PS GPIO 与中断&quot;">​</a></h2><h3 id="gpio-配置" tabindex="-1">GPIO 配置 <a class="header-anchor" href="#gpio-配置" aria-label="Permalink to &quot;GPIO 配置&quot;">​</a></h3><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">typedef</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	XGpioPs_Config GpioConfig</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">	/**&lt; Device configuration */</span></span>
<span class="line"><span style="color:#F07178;">	u32 IsReady</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">			/**&lt; Device is initialized and ready */</span></span>
<span class="line"><span style="color:#F07178;">	XGpioPs_Handler Handler</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">	/**&lt; Status handlers for all banks */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">CallBackRef</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> 		/**&lt; Callback ref for bank handlers */</span></span>
<span class="line"><span style="color:#F07178;">	u32 Platform</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">			/**&lt; Platform data */</span></span>
<span class="line"><span style="color:#F07178;">	u32 MaxPinNum</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">			/**&lt; Max pins in the GPIO device */</span></span>
<span class="line"><span style="color:#F07178;">	u8 MaxBanks</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">			/**&lt; Max banks in a GPIO device */</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> XGpioPs</span><span style="color:#89DDFF;">;</span></span></code></pre></div><p>配置步骤：</p><ol><li>全局变量与宏定义</li></ol><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GPIO_DEVICE_ID</span><span style="color:#A6ACCD;">      XPAR_XGPIOPS_0_DEVICE_ID</span><span style="color:#676E95;font-style:italic;">      //PS端GPIO器件ID（注意ZYNQ GPIO是按组分配的）</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">LED1</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">50</span><span style="color:#676E95;font-style:italic;">            //LED1 连接到 MIO50</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">KEY1</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0</span><span style="color:#676E95;font-style:italic;">         	//KEY1 连接到 MIO0</span></span>
<span class="line"><span style="color:#A6ACCD;">XGpioPs Gpiops</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">	// GPIO句柄</span></span></code></pre></div><ol start="2"><li>初始化函数</li></ol><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">XGpioPs_Config </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">ConfigPtr</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">	// 生成GPIO配置结构体，当然也可以将其作为全局变量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">ConfigPtr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">XGpioPs_LookupConfig</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GPIO_DEVICE_ID</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">	// 自动生成GPIO配置，主要是检查这个GPIO ID是否可用，并返回配置表</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ConfigPtr </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">NULL)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//初始化GPIO</span></span>
<span class="line"><span style="color:#82AAFF;">XGpioPs_CfgInitialize</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;font-style:italic;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ConfigPtr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ConfigPtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;font-style:italic;">BaseAddr</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//设置KEY所连接的MIO引脚的方向为输入</span></span>
<span class="line"><span style="color:#82AAFF;">XGpioPs_SetDirectionPin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;font-style:italic;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> KEY1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//设置LED所连接的MIO引脚的方向为输出并使能输出</span></span>
<span class="line"><span style="color:#82AAFF;">XGpioPs_SetDirectionPin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;font-style:italic;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> LED1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#82AAFF;">XGpioPs_SetOutputEnablePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;font-style:italic;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> LED1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#82AAFF;">XGpioPs_WritePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;font-style:italic;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> LED1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span></code></pre></div><h3 id="中断配置" tabindex="-1">中断配置 <a class="header-anchor" href="#中断配置" aria-label="Permalink to &quot;中断配置&quot;">​</a></h3><ol><li>全局变量与宏定义</li></ol><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">INTC_DEVICE_ID</span><span style="color:#A6ACCD;">      XPAR_SCUGIC_SINGLE_DEVICE_ID</span><span style="color:#676E95;font-style:italic;">  //通用中断控制器ID</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GPIO_INTERRUPT_ID</span><span style="color:#A6ACCD;">   XPAR_XGPIOPS_0_INTR</span><span style="color:#676E95;font-style:italic;">           //PS端GPIO中断ID</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">XScuGic intc</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">	// 中断句柄</span></span>
<span class="line"><span style="color:#A6ACCD;">u32 key_flag</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">   // 按键中断标志</span></span></code></pre></div><ol start="2"><li>中断回调函数与初始化函数</li></ol><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">intr_handler</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">callback_ref</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">init_interrupt</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">XScuGic </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">gic_ins_ptr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> XGpioPs </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">gpio</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u16 </span><span style="color:#A6ACCD;font-style:italic;">GpioIntrId</span><span style="color:#89DDFF;">);</span></span></code></pre></div><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">//中断处理函数</span></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">intr_handler</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">callback_ref</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    XGpioPs </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">gpio </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">XGpioPs </span><span style="color:#89DDFF;">*)</span><span style="color:#F07178;"> callback_ref</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//读取中断标志位，判断是否发生中断</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">XGpioPs_IntrGetStatusPin</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gpio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">)){</span></span>
<span class="line"><span style="color:#F07178;">        key_flag </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">TRUE;</span><span style="color:#676E95;font-style:italic;">							// 全局变量</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">XGpioPs_IntrDisablePin</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gpio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">         // 屏蔽按键KEY中断（不必要，若使用要在主函数中重启中断）</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_IntrClearPin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">      //清除中断标志（一定要清除中断标志位，否则会卡死在中断）</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">//初始化中断系统，使能KEY1按键的下降沿中断</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">init_interrupt</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">XScuGic </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">gic_ins_ptr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> XGpioPs </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">gpio</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u16 </span><span style="color:#A6ACCD;font-style:italic;">GpioIntrId</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    XScuGic_Config </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">IntcConfig</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//初始化中断控制器</span></span>
<span class="line"><span style="color:#F07178;">    IntcConfig </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XScuGic_LookupConfig</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">INTC_DEVICE_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(NULL</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> IntcConfig</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    status </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XScuGic_CfgInitialize</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gic_ins_ptr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> IntcConfig</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">IntcConfig</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">CpuBaseAddress</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置并使能中断</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">Xil_ExceptionRegisterHandler</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">XIL_EXCEPTION_ID_INT</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Xil_ExceptionHandler</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> XScuGic_InterruptHandler</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> gic_ins_ptr</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">Xil_ExceptionEnable</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置中断处理函数</span></span>
<span class="line"><span style="color:#F07178;">    status </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XScuGic_Connect</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gic_ins_ptr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> GpioIntrId</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Xil_ExceptionHandler</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> intr_handler</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*)</span><span style="color:#F07178;"> gpio</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//使能中断类型为来自GPIO的中断</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XScuGic_Enable</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gic_ins_ptr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> GpioIntrId</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置中断触发方式为下降沿中断</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_SetIntrTypePin</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gpio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> XGPIOPS_IRQ_TYPE_EDGE_FALLING</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//使能中断源</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_IntrEnablePin</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gpio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><ol start="3"><li>main函数</li></ol><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 省略配置GPIO输入输出状态</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//建立中断,出现错误则打印信息并退出</span></span>
<span class="line"><span style="color:#A6ACCD;">status </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">init_interrupt</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;font-style:italic;">intc</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;font-style:italic;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> GPIO_INTERRUPT_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> XST_SUCCESS</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">xil_printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Setup interrupt system failed</span><span style="color:#A6ACCD;">\r\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">key_flag</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#676E95;font-style:italic;">									//触发中断</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">usleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">20000</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">									//延时消抖</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">XGpioPs_ReadPin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#676E95;font-style:italic;">		//检测按键按下</span></span>
<span class="line"><span style="color:#F07178;">            key_val </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">~</span><span style="color:#F07178;">key_val</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#82AAFF;">XGpioPs_WritePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> LED1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> key_val</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">	//反转LED电平</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">        key_flag </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">FALSE;</span></span>
<span class="line"><span style="color:#F07178;">        </span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">XGpioPs_IntrEnablePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">     //使能中断 （不必要，若使用要在回调函数中失能中断）</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> XST_SUCCESS</span><span style="color:#89DDFF;">;</span></span></code></pre></div><h3 id="完整代码" tabindex="-1">完整代码 <a class="header-anchor" href="#完整代码" aria-label="Permalink to &quot;完整代码&quot;">​</a></h3><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xparameters.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xgpiops.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xscugic.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xil_exception.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xplatform_info.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">xil_printf.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">sleep.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GPIO_DEVICE_ID</span><span style="color:#A6ACCD;">      XPAR_XGPIOPS_0_DEVICE_ID</span><span style="color:#676E95;font-style:italic;">      //PS端GPIO器件ID</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">INTC_DEVICE_ID</span><span style="color:#A6ACCD;">      XPAR_SCUGIC_SINGLE_DEVICE_ID</span><span style="color:#676E95;font-style:italic;">  //通用中断控制器ID</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GPIO_INTERRUPT_ID</span><span style="color:#A6ACCD;">   XPAR_XGPIOPS_0_INTR</span><span style="color:#676E95;font-style:italic;">           //PS端GPIO中断ID</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">KEY1</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0</span><span style="color:#676E95;font-style:italic;">         	//KEY1 连接到 MIO0</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">LED1</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">50</span><span style="color:#676E95;font-style:italic;">            //LED1 连接到 MIO50</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">intr_handler</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">callback_ref</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">init_interrupt</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">XScuGic </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">gic_ins_ptr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> XGpioPs </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">gpio</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u16 </span><span style="color:#A6ACCD;font-style:italic;">GpioIntrId</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">XGpioPs Gpiops</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">	// GPIO句柄</span></span>
<span class="line"><span style="color:#A6ACCD;">XScuGic intc</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">	// 通用中断控制器句柄</span></span>
<span class="line"><span style="color:#A6ACCD;">u32 key_flag</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">  //按键中断标志</span></span>
<span class="line"><span style="color:#A6ACCD;">u32 key_val</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">    //控制LED亮灭</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    XGpioPs_Config </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">ConfigPtr</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">xil_printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mio interrupt </span><span style="color:#A6ACCD;">\r\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    ConfigPtr </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XGpioPs_LookupConfig</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">GPIO_DEVICE_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">ConfigPtr </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//初始化GPIO</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_CfgInitialize</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> ConfigPtr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ConfigPtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">BaseAddr</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置KEY所连接的MIO引脚的方向为输入</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_SetDirectionPin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置LED所连接的MIO引脚的方向为输出并使能输出</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_SetDirectionPin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> LED1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_SetOutputEnablePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> LED1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_WritePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> LED1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//建立中断,出现错误则打印信息并退出</span></span>
<span class="line"><span style="color:#F07178;">    status </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">init_interrupt</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">intc</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> GPIO_INTERRUPT_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">xil_printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Setup interrupt system failed</span><span style="color:#A6ACCD;">\r\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">key_flag</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#676E95;font-style:italic;">									//触发中断</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#82AAFF;">usleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">20000</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">									//延时消抖</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">XGpioPs_ReadPin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#676E95;font-style:italic;">		//检测按键按下</span></span>
<span class="line"><span style="color:#F07178;">                key_val </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">~</span><span style="color:#F07178;">key_val</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">                </span><span style="color:#82AAFF;">XGpioPs_WritePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> LED1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> key_val</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">	//反转LED电平</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">            key_flag </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">FALSE;</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#82AAFF;">XGpioPs_IntrClearPin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">      //清除中断标志</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#82AAFF;">XGpioPs_IntrEnablePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">     //使能中断</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//中断处理函数</span></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">intr_handler</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">callback_ref</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    XGpioPs </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">gpio </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">XGpioPs </span><span style="color:#89DDFF;">*)</span><span style="color:#F07178;"> callback_ref</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//读取中断标志位，判断是否发生中断</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">XGpioPs_IntrGetStatusPin</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gpio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">)){</span></span>
<span class="line"><span style="color:#F07178;">        key_flag </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">TRUE;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">XGpioPs_IntrDisablePin</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gpio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">         //屏蔽按键KEY中断</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//初始化中断系统，使能KEY1按键的下降沿中断</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">init_interrupt</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">XScuGic </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">gic_ins_ptr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> XGpioPs </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">gpio</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u16 </span><span style="color:#A6ACCD;font-style:italic;">GpioIntrId</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    XScuGic_Config </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">IntcConfig</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//初始化中断控制器</span></span>
<span class="line"><span style="color:#F07178;">    IntcConfig </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XScuGic_LookupConfig</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">INTC_DEVICE_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(NULL</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> IntcConfig</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    status </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XScuGic_CfgInitialize</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gic_ins_ptr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> IntcConfig</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">IntcConfig</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">CpuBaseAddress</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置并使能中断</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">Xil_ExceptionRegisterHandler</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">XIL_EXCEPTION_ID_INT</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Xil_ExceptionHandler</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> XScuGic_InterruptHandler</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> gic_ins_ptr</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">Xil_ExceptionEnable</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置中断处理函数</span></span>
<span class="line"><span style="color:#F07178;">    status </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XScuGic_Connect</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gic_ins_ptr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> GpioIntrId</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Xil_ExceptionHandler</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> intr_handler</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*)</span><span style="color:#F07178;"> gpio</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//使能中断类型为来自GPIO的中断</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XScuGic_Enable</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gic_ins_ptr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> GpioIntrId</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置中断触发方式为下降沿中断</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_SetIntrTypePin</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gpio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> XGPIOPS_IRQ_TYPE_EDGE_FALLING</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//使能中断源</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_IntrEnablePin</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gpio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h2 id="emio" tabindex="-1">EMIO <a class="header-anchor" href="#emio" aria-label="Permalink to &quot;EMIO&quot;">​</a></h2><p>在开启EMIO并为其创建引脚约束后可得以下文件：</p><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">set_property IOSTANDARD LVCMOS33 [get_ports {GPIO_0_0_tri_io[1]}]</span></span>
<span class="line"><span style="color:#A6ACCD;">set_property IOSTANDARD LVCMOS33 [get_ports {GPIO_0_0_tri_io[0]}]</span></span>
<span class="line"><span style="color:#A6ACCD;">set_property PACKAGE_PIN E19 [get_ports {GPIO_0_0_tri_io[1]}]</span></span>
<span class="line"><span style="color:#A6ACCD;">set_property PACKAGE_PIN H19 [get_ports {GPIO_0_0_tri_io[0]}]</span></span></code></pre></div><p>由于EMIO的编号是从54开始的，因此<code>GPIO_0_0_tri_io[0]</code>，也就是LED输出引脚在程序中应被定义为54，同理对于<code>GPIO_0_0_tri_io[1]</code>，也就是KEY输入引脚在程序中应被定义为55</p><h3 id="完整代码-1" tabindex="-1">完整代码 <a class="header-anchor" href="#完整代码-1" aria-label="Permalink to &quot;完整代码&quot;">​</a></h3><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">stdio.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xil_printf.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xgpiops.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xgpiops_hw.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">sleep.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">EMIOLED1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">54</span><span style="color:#676E95;font-style:italic;"> //PL_LED1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">EMIOKEY1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">55</span><span style="color:#676E95;font-style:italic;">  //PL_KEY1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">input</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">output</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">XGpioPs Gpios</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> Status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">     XGpioPs_Config </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">ConfigPtr</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">EMIO Test! </span><span style="color:#A6ACCD;">\n\r</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 查找并初始化GPIO控制器</span></span>
<span class="line"><span style="color:#F07178;">     ConfigPtr </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XGpioPs_LookupConfig</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">XPAR_XGPIOPS_0_DEVICE_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">     Status </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XGpioPs_CfgInitialize</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpios</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> ConfigPtr</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#A6ACCD;">ConfigPtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">BaseAddr</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Status </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// 为GPIO配置方向</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_SetDirectionPin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpios</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">EMIOLED1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">output</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_SetDirectionPin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpios</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">EMIOKEY1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">input</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// 开启LED引脚输出</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_SetOutputEnablePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpios</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">EMIOLED1</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 轮询KEY引脚电平并设置LED输出</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">XGpioPs_ReadPin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpios</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">EMIOKEY1</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    		</span><span style="color:#82AAFF;">XGpioPs_WritePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpios</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">EMIOLED1</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    		</span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">led on</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    	</span><span style="color:#89DDFF;font-style:italic;">else</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    		</span><span style="color:#82AAFF;">XGpioPs_WritePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Gpios</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">EMIOLED1</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    		</span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">led off</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    	</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h2 id="axi-gpio" tabindex="-1">AXI GPIO <a class="header-anchor" href="#axi-gpio" aria-label="Permalink to &quot;AXI GPIO&quot;">​</a></h2><ol><li>创建axi_GPIO ip 核</li><li>为axi_GPIO配置宽度并使能中断，此时axi_GPIO增加一个中断输出引脚<code>ip2intc_irpt</code></li><li>将上一步产生的中断引脚连接到ZYNQ的<code>IRQ_F2F</code>中断</li></ol><p><img src="/MyWeb/assets/image-20230708101049065.6b2f5061.png" alt="image-20230708101049065"></p><h3 id="完整代码-2" tabindex="-1">完整代码 <a class="header-anchor" href="#完整代码-2" aria-label="Permalink to &quot;完整代码&quot;">​</a></h3><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">stdio.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xparameters.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xgpiops.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xgpio.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xscugic.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xil_exception.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xil_printf.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">sleep.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//器件ID宏定义</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SCUGIC_ID</span><span style="color:#A6ACCD;">	XPAR_SCUGIC_0_DEVICE_ID</span><span style="color:#676E95;font-style:italic;">		//中断控制器</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GPIOPS_ID</span><span style="color:#A6ACCD;">   XPAR_XGPIOPS_0_DEVICE_ID</span><span style="color:#676E95;font-style:italic;">   	//PS端  GPIO器件</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AXI_GPIO_ID</span><span style="color:#A6ACCD;"> XPAR_AXI_GPIO_0_DEVICE_ID</span><span style="color:#676E95;font-style:italic;">	//PL端  AXI GPIO器件</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GPIO_INT_ID</span><span style="color:#A6ACCD;"> XPAR_FABRIC_GPIO_0_VEC_ID</span><span style="color:#676E95;font-style:italic;">	//PL端  AXI GPIO中断</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//连接端口宏定义</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MIO_LED1</span><span style="color:#A6ACCD;">     </span><span style="color:#F78C6C;">50</span><span style="color:#676E95;font-style:italic;">   						//PS LED1 连接到 MIO50</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">KEY_CHANNEL</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">1</span><span style="color:#676E95;font-style:italic;">							//PL_KEY1使用AXI GPIO通道1</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">KEY_MASK</span><span style="color:#A6ACCD;">     XGPIO_IR_CH1_MASK</span><span style="color:#676E95;font-style:italic;"> 			//通道1的位定义</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//函数声明</span></span>
<span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">axi_gpio_intr_handler</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">CallbackRef</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">		//中断服务函数</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//PS端GPIO</span></span>
<span class="line"><span style="color:#A6ACCD;">XGpioPs          gpiops</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">     				//PS端 GPIO 驱动实例</span></span>
<span class="line"><span style="color:#A6ACCD;">XGpioPs_Config </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> gpiops_cfg</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> 				//PS端 GPIO 配置信息</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//PL端AXI_GPIO</span></span>
<span class="line"><span style="color:#A6ACCD;">XGpio            axi_gpio</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">					//PL端 AXI GPIO 驱动实例</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//中断控制</span></span>
<span class="line"><span style="color:#A6ACCD;">XScuGic 		 scugic</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">					//中断控制器  驱动实例</span></span>
<span class="line"><span style="color:#A6ACCD;">XScuGic_Config </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> scugic_cfg</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> 				//中断控制器  配置信息</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> led_val</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">								//LED显示状态</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> key_flag</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">								//中断标志</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">AXI_GPIO Test!</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//初始化PS端  GPIO驱动</span></span>
<span class="line"><span style="color:#F07178;">    gpiops_cfg </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XGpioPs_LookupConfig</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">GPIOPS_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_CfgInitialize</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> gpiops_cfg</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">gpiops_cfg</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">BaseAddr</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//初始化PL端  AXI GPIO驱动</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpio_Initialize</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">axi_gpio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> AXI_GPIO_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//初始化中断控制器驱动</span></span>
<span class="line"><span style="color:#F07178;">	scugic_cfg </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XScuGic_LookupConfig</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">SCUGIC_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XScuGic_CfgInitialize</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">scugic</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> scugic_cfg</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">scugic_cfg</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">CpuBaseAddress</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//配置PS GPIO</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_SetDirectionPin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> MIO_LED1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">		//设置 PS GPIO 为输出</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_SetOutputEnablePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> MIO_LED1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">	//使能LED输出</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpioPs_WritePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> MIO_LED1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> led_val</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">		//点亮LED</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//配置PL AXI GPIO</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpio_SetDataDirection</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">axi_gpio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY_CHANNEL</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;"> //设置PL AXI GPIO通道1为输入</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpio_InterruptEnable</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">axi_gpio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY_MASK</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">		//使能通道1中断</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XGpio_InterruptGlobalEnable</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">axi_gpio</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">			//使能AXI GPIO全局中断</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置中断优先级和触发类型(高电平触发)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XScuGic_SetPriorityTriggerType</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">scugic</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> GPIO_INT_ID</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xA0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0x1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//关联中断源AXI_GPIO和中断处理函数axi_gpio_intr_handler</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XScuGic_Connect</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">scugic</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> GPIO_INT_ID</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> axi_gpio_intr_handler</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">axi_gpio</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//使能AXI GPIO中断</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XScuGic_Enable</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">scugic</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> GPIO_INT_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置并打开中断异常处理功能</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">Xil_ExceptionInit</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">Xil_ExceptionRegisterHandler</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">XIL_EXCEPTION_ID_INT</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    		</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Xil_ExceptionHandler</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;">XScuGic_InterruptHandler</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">scugic</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">Xil_ExceptionEnable</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">key_flag</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">    	</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    		key_flag</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    		led_val </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">~</span><span style="color:#F07178;">led_val</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    		</span><span style="color:#82AAFF;">XGpioPs_WritePin</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">gpiops</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> MIO_LED1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> led_val</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">	//改变LED亮灭</span></span>
<span class="line"><span style="color:#F07178;">    		</span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pin pressed!</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    	</span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">running</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    	</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// AXI GPIO 中断服务函数</span></span>
<span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">axi_gpio_intr_handler</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">CallbackRef</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> key_value </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	XGpio </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">GpioPtr </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">XGpio </span><span style="color:#89DDFF;">*)</span><span style="color:#F07178;">CallbackRef</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">triggered </span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	key_value </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XGpio_DiscreteRead</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">GpioPtr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY_CHANNEL</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">usleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">100000</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">											//延时100ms,按键消抖</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">key_value </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">){</span><span style="color:#676E95;font-style:italic;">										//判断按键按下</span></span>
<span class="line"><span style="color:#F07178;">		key_flag</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">//XGpio_InterruptDisable(GpioPtr, KEY_MASK);				//AXI GPIO中断失能（不必要）</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">XGpio_InterruptClear</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">axi_gpio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> KEY_MASK</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">					//清除中断标志</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">//XGpio_InterruptEnable(&amp;axi_gpio, KEY_MASK);				//AXI GPIO中断使能（不必要）</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><blockquote><p>如果没法进入中断需要重置开发板，可能的原因是上次运行未清除中断标志位</p></blockquote><h2 id="uart" tabindex="-1">UART <a class="header-anchor" href="#uart" aria-label="Permalink to &quot;UART&quot;">​</a></h2><img src="/MyWeb/assets/image-20230711110216430.856689d8.png" alt="image-20230711110216430" style="zoom:50%;"><img src="/MyWeb/assets/image-20230711110329489.78fc34c9.png" alt="image-20230711110329489" style="zoom:50%;"><h3 id="四种路由模式" tabindex="-1">四种路由模式 <a class="header-anchor" href="#四种路由模式" aria-label="Permalink to &quot;四种路由模式&quot;">​</a></h3><img src="/MyWeb/assets/image-20230711111202022.f1dc47a8.png" alt="image-20230711111202022" style="zoom:50%;"><h3 id="configure-controller-functions" tabindex="-1">Configure Controller Functions <a class="header-anchor" href="#configure-controller-functions" aria-label="Permalink to &quot;Configure Controller Functions&quot;">​</a></h3><p>This example configures the character frame, the baud rate, the FIFO trigger levels, the Rx timeout mechanism, and enables the controller. All of these steps are necessary after a reset, but not necessary between enabling and disabling the controller.</p><ol><li>Configure UART character frame. Write 0x0000_0020 into the uart.mode_reg0:</li><li>Configure the Baud Rate</li><li>Set the level of the RxFIFO trigger level</li><li>Enable the Controller</li><li>Program the Receiver Timeout Mechanism</li></ol><h3 id="transmit-data" tabindex="-1">Transmit Data <a class="header-anchor" href="#transmit-data" aria-label="Permalink to &quot;Transmit Data&quot;">​</a></h3><p>Software can used <strong>polling</strong> or <strong>interrupts</strong> to control the flow of data to the TxFIFO and RxFIFO.</p><p><u>Note: When the TxFIFO Empty status is true, software can write 64 bytes (the size of the TxFIFO) without checking the TxFIFO status. In reality, software can write more than 64 bytes when the transmitter is active because while the software is writing data to the TxFIFO, the controller is removing data and serializing it onto the TxD signal.</u></p><h4 id="transmit-data-using-the-interrupt-method" tabindex="-1">Transmit Data using the Interrupt Method <a class="header-anchor" href="#transmit-data-using-the-interrupt-method" aria-label="Permalink to &quot;Transmit Data using the Interrupt Method&quot;">​</a></h4><ol><li>Disable the TxFIFO Empty interrupt.</li><li>Fill the TxFIFO with data</li><li>Check to see if the TxFIFO has room to another byte of data (i.e., the TxFIFO is not full):</li><li>Repeat step 2 and 3</li><li>Enable the interrupt.</li><li>Wait until the TxFIFO is empty.</li></ol><h4 id="receive-data-using-the-interrupt-method" tabindex="-1">Receive Data using the Interrupt Method <a class="header-anchor" href="#receive-data-using-the-interrupt-method" aria-label="Permalink to &quot;Receive Data using the Interrupt Method&quot;">​</a></h4><ol><li>Enable interrupts.</li><li>Wait until the RxFIFO is filled up to the trigger level or Rx timeout</li><li>Read data from the RxFIFO</li><li>Repeat step 2 and 3 until the FIFO is empty.</li><li>Clear the interrupt status bits if set.</li></ol><h3 id="完整代码-3" tabindex="-1">完整代码 <a class="header-anchor" href="#完整代码-3" aria-label="Permalink to &quot;完整代码&quot;">​</a></h3><p>使用串口1，具体引脚需要根据开发板确定，一般默认即可，本代码实现了默认启用串口1后的数据回环功能，但是是我们手动实现的，覆盖了自动生成的代码。其中设有标志位<code>ReceivedFlag</code>，在中断回调函数中将其置位为1表示有数据输入。</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xparameters.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xuartps.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xil_printf.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xscugic.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">stdio.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UART_DEVICE_ID</span><span style="color:#A6ACCD;">     XPAR_XUARTPS_0_DEVICE_ID</span><span style="color:#676E95;font-style:italic;">    	//串口设备ID</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">INTC_DEVICE_ID</span><span style="color:#A6ACCD;">     XPAR_SCUGIC_SINGLE_DEVICE_ID</span><span style="color:#676E95;font-style:italic;"> //中断ID</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UART_INT_IRQ_ID</span><span style="color:#A6ACCD;">    XPAR_XUARTPS_1_INTR</span><span style="color:#676E95;font-style:italic;">          //串口中断ID</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">XScuGic Intc</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">              //中断控制器驱动程序实例</span></span>
<span class="line"><span style="color:#A6ACCD;">XUartPs Uart_Ps</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">           //串口驱动程序实例</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_LEN</span><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">2000</span><span style="color:#676E95;font-style:italic;">			//数据缓冲区大小</span></span>
<span class="line"><span style="color:#A6ACCD;">u8 ReceivedBuffer</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">MAX_LEN</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">	/* 接收数组 */</span></span>
<span class="line"><span style="color:#A6ACCD;">u8 </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">ReceivedBufferPtr </span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">			/* 指针*/</span></span>
<span class="line"><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> u32 ReceivedByteNum </span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">	/* 数据计数 */</span></span>
<span class="line"><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> u32 ReceivedFlag  </span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">	//接收完成标志</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">XUartPsFormat UartFormat </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#F78C6C;">115200</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">		XUARTPS_FORMAT_8_BITS</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">		XUARTPS_FORMAT_NO_PARITY</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">		XUARTPS_FORMAT_1_STOP_BIT</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Function declaration</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UartPsSend</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">XUartPs </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">InstancePtr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u8 </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">BufferPtr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u32 </span><span style="color:#A6ACCD;font-style:italic;">NumBytes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UartPsRev</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">XUartPs </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">InstancePtr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u8 </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">BufferPtr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u32 </span><span style="color:#A6ACCD;font-style:italic;">NumBytes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UartInit</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">XUartPs</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">uart_ps</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Handler</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">call_back_ref</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UartIntrInit</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">XScuGic </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">intc</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> XUartPs </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">uart_ps</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//main函数</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    u32 SendByteNum </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    u8 </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">SendBufferPtr </span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    ReceivedBufferPtr </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> ReceivedBuffer </span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    ReceivedFlag </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    ReceivedByteNum </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    status </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">UartInit</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Uart_Ps</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;">    //串口初始化</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">status </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">xil_printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Uart Initial Failed</span><span style="color:#A6ACCD;">\r\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">UartIntrInit</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Intc</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">Uart_Ps</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;"> //串口中断初始化</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">xil_printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Uart Initial Successful</span><span style="color:#A6ACCD;">\r\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">ReceivedFlag</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">    		</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    			ReceivedBufferPtr </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> ReceivedBuffer </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    			SendBufferPtr </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> ReceivedBuffer </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    			SendByteNum </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> ReceivedByteNum </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    			ReceivedFlag </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    			ReceivedByteNum </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    			</span><span style="color:#82AAFF;">UartPsSend</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Uart_Ps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> SendBufferPtr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> SendByteNum</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//UART初始化函数</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UartInit</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">XUartPs</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">uart_ps</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    XUartPs_Config </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">uart_cfg</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    uart_cfg </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XUartPs_LookupConfig</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">UART_DEVICE_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(NULL</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> uart_cfg</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    status </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XUartPs_CfgInitialize</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">uart_ps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> uart_cfg</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">uart_cfg</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">BaseAddress</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//UART设备自检</span></span>
<span class="line"><span style="color:#F07178;">    status </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XUartPs_SelfTest</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">uart_ps</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置工作模式:普通模式</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XUartPs_SetOperMode</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">uart_ps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> XUARTPS_OPER_MODE_NORMAL</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /* 波特率 115200, 八位符号位，无奇偶校验位，一位停止位 */</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XUartPs_SetDataFormat</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">uart_ps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">UartFormat</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置RxFIFO的中断触发等级</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XUartPs_SetFifoThreshold</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">uart_ps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//UART中断服务函数</span></span>
<span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Handler</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">call_back_ref</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    XUartPs </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">uart_instance_ptr </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">XUartPs </span><span style="color:#89DDFF;">*)</span><span style="color:#F07178;"> call_back_ref</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    u32 ReceivedCount </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    u32 UartSrValue </span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    UartSrValue </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XUartPs_ReadReg</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">uart_instance_ptr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">Config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseAddress</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> XUARTPS_SR_OFFSET</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">XUARTPS_IXR_RXOVR</span><span style="color:#89DDFF;">|</span><span style="color:#F07178;">XUARTPS_IXR_RXEMPTY</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    ReceivedFlag </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">		// 信号接收标志位</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">UartSrValue </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> XUARTPS_IXR_RXOVR</span><span style="color:#89DDFF;">)</span><span style="color:#676E95;font-style:italic;">   /* 检测中断触发 */</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        ReceivedCount </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">UartPsRev</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">Uart_Ps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> ReceivedBufferPtr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> MAX_LEN</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        ReceivedByteNum </span><span style="color:#89DDFF;">+=</span><span style="color:#F07178;"> ReceivedCount </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        ReceivedBufferPtr </span><span style="color:#89DDFF;">+=</span><span style="color:#F07178;"> ReceivedCount </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        /* 清除中断标志 */</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">XUartPs_WriteReg</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">uart_instance_ptr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">Config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseAddress</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> XUARTPS_ISR_OFFSET</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> XUARTPS_IXR_RXOVR</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">UartSrValue </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> XUARTPS_IXR_RXEMPTY</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">XUartPs_WriteReg</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">uart_instance_ptr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">Config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseAddress</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> XUARTPS_ISR_OFFSET</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> XUARTPS_IXR_RXEMPTY</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        ReceivedFlag </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">	// 信号接收标志位置1表示有串口数据</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//串口中断初始化</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UartIntrInit</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">XScuGic </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">intc</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> XUartPs </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">uart_ps</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> status</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//初始化中断控制器</span></span>
<span class="line"><span style="color:#F07178;">    XScuGic_Config </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">intc_cfg</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    intc_cfg </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XScuGic_LookupConfig</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">INTC_DEVICE_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(NULL</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> intc_cfg</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    status </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XScuGic_CfgInitialize</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">intc</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> intc_cfg</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">intc_cfg</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">CpuBaseAddress</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">status </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_FAILURE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置并打开中断异常处理功能</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">Xil_ExceptionInit</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">Xil_ExceptionRegisterHandler</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">XIL_EXCEPTION_ID_INT</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Xil_ExceptionHandler</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;">XScuGic_InterruptHandler</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*)</span><span style="color:#F07178;">intc</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">Xil_ExceptionEnable</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//为中断设置中断处理函数</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XScuGic_Connect</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">intc</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> UART_INT_IRQ_ID</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Xil_ExceptionHandler</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> Handler</span><span style="color:#89DDFF;">,(</span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*)</span><span style="color:#F07178;"> uart_ps</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置UART的中断触发方式</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XUartPs_SetInterruptMask</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">uart_ps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> XUARTPS_IXR_RXOVR</span><span style="color:#89DDFF;">|</span><span style="color:#F07178;">XUARTPS_IXR_RXEMPTY</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//使能GIC中的串口中断</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">XScuGic_Enable</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">intc</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> UART_INT_IRQ_ID</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XST_SUCCESS</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//发送数据</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UartPsSend</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">XUartPs </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">InstancePtr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u8 </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">BufferPtr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u32 </span><span style="color:#A6ACCD;font-style:italic;">NumBytes</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	u32 SentCount </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0U</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/* 设置数据缓冲区 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">SendBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RequestedBytes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> NumBytes</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">SendBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RemainingBytes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> NumBytes</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">SendBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NextBytePtr</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> BufferPtr</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">SendBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RemainingBytes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> SentCount</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		/* 将缓冲区的数据填充到FIFO中 */</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">XUartPs_IsTransmitFull</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">Config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseAddress</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#82AAFF;">XUartPs_WriteReg</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">Config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseAddress</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">					XUARTPS_FIFO_OFFSET</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">					</span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">u32</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">SendBuffer</span><span style="color:#F07178;">.</span></span>
<span class="line"><span style="color:#F07178;">							</span><span style="color:#A6ACCD;">NextBytePtr</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">SentCount</span><span style="color:#89DDFF;">]));</span></span>
<span class="line"><span style="color:#F07178;">			SentCount</span><span style="color:#89DDFF;">++;</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/* 更新缓冲区 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">SendBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NextBytePtr</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+=</span><span style="color:#F07178;"> SentCount</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">SendBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RemainingBytes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-=</span><span style="color:#F07178;"> SentCount</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> SentCount</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//接收数据</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UartPsRev</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">XUartPs </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">InstancePtr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u8 </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">BufferPtr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u32 </span><span style="color:#A6ACCD;font-style:italic;">NumBytes</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	u32 ReceivedCount </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	u32 CsrRegister</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/* 设置缓冲区 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">ReceiveBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RequestedBytes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> NumBytes</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">ReceiveBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RemainingBytes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> NumBytes</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">ReceiveBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NextBytePtr</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> BufferPtr</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*读取通道状态确定是否收到数据 */</span></span>
<span class="line"><span style="color:#F07178;">	CsrRegister </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XUartPs_ReadReg</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">Config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseAddress</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			XUARTPS_SR_OFFSET</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*读取数据并将它们存储到缓冲区	 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">ReceivedCount </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">ReceiveBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RemainingBytes</span><span style="color:#89DDFF;">)&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">(((</span><span style="color:#F07178;">CsrRegister </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> XUARTPS_SR_RXEMPTY</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">u32</span><span style="color:#89DDFF;">)</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)))</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">ReceiveBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NextBytePtr</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">ReceivedCount</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#82AAFF;">XUartPs_ReadReg</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">Config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseAddress</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">XUARTPS_FIFO_OFFSET</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">		ReceivedCount</span><span style="color:#89DDFF;">++;</span></span>
<span class="line"><span style="color:#F07178;">		CsrRegister </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XUartPs_ReadReg</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">Config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseAddress</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				XUARTPS_SR_OFFSET</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">is_rxbs_error</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">ReceiveBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NextBytePtr</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL){</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">ReceiveBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NextBytePtr</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+=</span><span style="color:#F07178;"> ReceivedCount</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">InstancePtr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">ReceiveBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RemainingBytes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-=</span><span style="color:#F07178;"> ReceivedCount</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> ReceivedCount</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h2 id="time" tabindex="-1">Time <a class="header-anchor" href="#time" aria-label="Permalink to &quot;Time&quot;">​</a></h2></div></div></main><footer class="VPDocFooter" data-v-c4b0d3cf data-v-face870a><!--[--><!--]--><div class="edit-info" data-v-face870a><div class="edit-link" data-v-face870a><a class="VPLink link edit-link-button" href="/MyWeb/" data-v-face870a data-v-8f4dc553><!--[--><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="edit-link-icon" aria-label="edit icon" data-v-face870a><path d="M18,23H4c-1.7,0-3-1.3-3-3V6c0-1.7,1.3-3,3-3h7c0.6,0,1,0.4,1,1s-0.4,1-1,1H4C3.4,5,3,5.4,3,6v14c0,0.6,0.4,1,1,1h14c0.6,0,1-0.4,1-1v-7c0-0.6,0.4-1,1-1s1,0.4,1,1v7C21,21.7,19.7,23,18,23z"></path><path d="M8,17c-0.3,0-0.5-0.1-0.7-0.3C7,16.5,6.9,16.1,7,15.8l1-4c0-0.2,0.1-0.3,0.3-0.5l9.5-9.5c1.2-1.2,3.2-1.2,4.4,0c1.2,1.2,1.2,3.2,0,4.4l-9.5,9.5c-0.1,0.1-0.3,0.2-0.5,0.3l-4,1C8.2,17,8.1,17,8,17zM9.9,12.5l-0.5,2.1l2.1-0.5l9.3-9.3c0.4-0.4,0.4-1.1,0-1.6c-0.4-0.4-1.2-0.4-1.6,0l0,0L9.9,12.5z M18.5,2.5L18.5,2.5L18.5,2.5z"></path></svg> Edit this page on GitHub<!--]--><!----></a></div><!----></div><div class="prev-next" data-v-face870a><div class="pager" data-v-face870a><!----></div><div class="pager" data-v-face870a><a class="pager-link next" href="/MyWeb/course/common-component2.html" data-v-face870a><span class="desc" data-v-face870a>Next page</span><span class="title" data-v-face870a>part B</span></a></div></div></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-b2cf3e0b data-v-f7fc41f4><div class="container" data-v-f7fc41f4><p class="message" data-v-f7fc41f4>Released under the MIT License.</p><p class="copyright" data-v-f7fc41f4>Copyright © 2023-present yangs</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"links_index.md\":\"9c23b018\",\"course_index.md\":\"eb6776a0\",\"api-examples.md\":\"6c1ba2c1\",\"course_common-component2.md\":\"f1355efc\",\"guide_page2.md\":\"dba980fa\",\"course_pro-component2.md\":\"33fe7f2b\",\"markdown-examples.md\":\"29afca2b\",\"changelog_index.md\":\"cef1e862\",\"note_index.md\":\"8ce10670\",\"index.md\":\"f7009d6f\",\"course_pro-component1.md\":\"4b9c69ed\",\"course_basic-component2.md\":\"861443bc\",\"course_common-component1.md\":\"897ccd71\",\"course_basic-component1.md\":\"86f1611f\",\"guide_index.md\":\"e9900bd4\",\"guide_quickstart.md\":\"f9c684a4\",\"note_ts_现代管理基础note.md\":\"deb67c5e\",\"note_signal_lab_signal_lab_1_note.md\":\"873b19e8\",\"note_signal_lab_lab1.md\":\"ecbccbd6\",\"course_fpgaembedded.md\":\"11f87350\",\"we_wenote.md\":\"052116cc\",\"note_signal_lab_lab4.md\":\"b409a4f7\",\"note_signal_lab_lab2.md\":\"936000cb\",\"note_轮式.md\":\"613cadce\",\"note_signal_lab_lab3.md\":\"029397e3\",\"note_工程原理_solution.md\":\"0266d141\",\"note_变分法.md\":\"92cd4361\",\"note_signal_a42.md\":\"fa3b3d8e\",\"note_deeplearning.md\":\"de63d79f\",\"note_slamnote.md\":\"ee8ad180\",\"note_工程原理_工程原理复习提纲.md\":\"292cf4b4\",\"note_signal_信号与系统note.md\":\"5c65d4fd\",\"note_electromagneticfieldandwave.md\":\"397781a7\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"cn-ZH\",\"dir\":\"ltr\",\"title\":\"Blog time !\",\"description\":\"more infomation\",\"base\":\"/MyWeb/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"/logo.png\",\"nav\":[{\"text\":\"course\",\"link\":\"/course/index\",\"activeMatch\":\"/course/\"},{\"text\":\"note\",\"link\":\"/note/index\",\"activeMatch\":\"/note/\"},{\"text\":\"world edit\",\"link\":\"/we/WeNote\",\"activeMatch\":\"/we/\"},{\"text\":\"more\",\"items\":[{\"text\":\"更新日志\",\"link\":\"/changelog/index.md\"},{\"text\":\"友情链接\",\"link\":\"/links/index\"},{\"text\":\"BiliBili page\",\"link\":\"https://space.bilibili.com/19471313?spm_id_from=333.1007.0.0\"}]}],\"sidebar\":{\"/note/\":[{\"text\":\"笔记\",\"collapsible\":true,\"items\":[{\"text\":\"Electromagnetic Theory\",\"link\":\"/note/ElectromagneticFieldandWave\"},{\"text\":\"Deep Learning Note\",\"link\":\"/note/Deeplearning\"},{\"text\":\"SLAM Note\",\"link\":\"/note/SLAMNote\"},{\"text\":\"变分法\",\"link\":\"/note/变分法\"}]},{\"text\":\"signal and system\",\"collapsible\":true,\"items\":[{\"text\":\"信号与系统笔记\",\"link\":\"/note/signal/信号与系统Note\"},{\"text\":\"信号与系统final\",\"link\":\"/note/signal/A42\"},{\"text\":\"Lab 1 note\",\"link\":\"/note/signal/lab/Signal_lab_1_note\"},{\"text\":\"Lab 1 ans\",\"link\":\"/note/signal/lab/Lab1\"},{\"text\":\"Lab 2 ans\",\"link\":\"/note/signal/lab/lab2\"},{\"text\":\"Lab 3 ans\",\"link\":\"/note/signal/lab/lab3\"},{\"text\":\"Lab 4 ans\",\"link\":\"/note/signal/lab/lab4\"}]},{\"text\":\"工程原理复习提纲\",\"collapsible\":true,\"items\":[{\"text\":\"工程原理复习提纲\",\"link\":\"/note/工程原理/工程原理复习提纲\"},{\"text\":\"2022 final solution\",\"link\":\"/note/工程原理/solution\"}]},{\"text\":\"轮式\",\"collapsible\":true,\"items\":[{\"text\":\"轮式\",\"link\":\"/note/轮式\"}]},{\"text\":\"通识\",\"collapsible\":true,\"items\":[{\"text\":\"现代管理基础\",\"link\":\"/note/TS/现代管理基础Note\"}]}],\"/course/\":[{\"text\":\"课程资料\",\"collaped\":false,\"items\":[{\"text\":\"ZYNQ embedded\",\"link\":\"/course/FPGAEmbedded\"},{\"text\":\"part B\",\"link\":\"/course/common-component2\"}]}],\"/we/\":[{\"text\":\"World edit\",\"collapsible\":true,\"items\":[{\"text\":\"WorldEdit Expressions & Noise Functions\",\"link\":\"/we/WeNote\"}]}]},\"editLink\":{\"pattern\":\"/\",\"text\":\"Edit this page on GitHub\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/Fox-Block?tab=overview&from=2023-03-01&to=2023-03-12\"}],\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2023-present yangs\"}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}")</script>
    
  </body>
</html>